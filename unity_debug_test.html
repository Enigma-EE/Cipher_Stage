<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unity WebSocket è°ƒè¯•å·¥å…·</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .log { background: #f5f5f5; padding: 10px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .btn { padding: 8px 16px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        .btn:hover { background: #0056b3; }
        .status { padding: 5px 10px; border-radius: 3px; font-weight: bold; }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        input, select { padding: 5px; margin: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Unity WebSocket è°ƒè¯•å·¥å…·</h1>
        
        <div class="section">
            <h3>ğŸ“¡ è¿æ¥è®¾ç½®</h3>
            <label>ç›‘æ§ç«¯å£: <input type="number" id="monitorPort" value="48913" /></label>
            <label>è§’è‰²åç§°: <input type="text" id="lanlanName" value="EE" /></label>
            <br>
            <button class="btn" onclick="connectToUnityWS()">è¿æ¥åˆ°Unityç«¯ç‚¹ (/ws/)</button>
            <button class="btn" onclick="connectToSyncWS()">è¿æ¥åˆ°åŒæ­¥ç«¯ç‚¹ (/sync/)</button>
            <button class="btn" onclick="disconnect()">æ–­å¼€è¿æ¥</button>
            <br>
            <span id="wsStatus" class="status disconnected">æœªè¿æ¥</span>
        </div>

        <div class="section">
            <h3>ğŸ® UnityæŒ‡ä»¤æµ‹è¯•</h3>
            <button class="btn" onclick="sendAnimationCommand()">å‘é€åŠ¨ç”»æŒ‡ä»¤ (EE_vrm_baked)</button>
            <button class="btn" onclick="sendExpressionCommand()">å‘é€è¡¨æƒ…æŒ‡ä»¤ (happy)</button>
            <button class="btn" onclick="sendMouthCommand()">å‘é€å£å‹æŒ‡ä»¤</button>
            <button class="btn" onclick="sendCustomCommand()">å‘é€è‡ªå®šä¹‰æŒ‡ä»¤</button>
            <br>
            <textarea id="customCommand" rows="3" cols="60" placeholder='{"type":"anim.play","state":"EE_vrm_baked","layer":0,"fade":0.25,"speed":1}'></textarea>
        </div>

        <div class="section">
            <h3>ğŸ”„ APIæµ‹è¯•</h3>
            <button class="btn" onclick="testUnityAPI()">æµ‹è¯• /api/unity/send</button>
            <button class="btn" onclick="testLLMTrigger()">æ¨¡æ‹ŸLLMè§¦å‘</button>
        </div>

        <div class="section">
            <h3>ğŸ“‹ æ¶ˆæ¯æ—¥å¿—</h3>
            <button class="btn" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            <div id="log" class="log"></div>
        </div>

        <div class="section">
            <h3>ğŸ“– ä½¿ç”¨è¯´æ˜</h3>
            <ul>
                <li><strong>Unityç«¯ç‚¹ (/ws/)</strong>: Unityåº”è¯¥è¿æ¥è¿™ä¸ªç«¯ç‚¹æ¥æ”¶æŒ‡ä»¤</li>
                <li><strong>åŒæ­¥ç«¯ç‚¹ (/sync/)</strong>: ä¸»æœåŠ¡å™¨ç”¨æ¥å‘é€æŒ‡ä»¤åˆ°ç›‘æ§æœåŠ¡</li>
                <li><strong>æ­£å¸¸æµç¨‹</strong>: LLM â†’ /api/unity/send â†’ é˜Ÿåˆ— â†’ /sync/ â†’ å¹¿æ’­åˆ° /ws/</li>
                <li><strong>æ£€æŸ¥Unity</strong>: ç¡®ä¿Unityè¿æ¥åˆ° ws://localhost:48912/ws/EE</li>
            </ul>
        </div>
    </div>

    <script>
        let ws = null;
        let wsType = '';

        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'send' ? 'ğŸ“¤' : type === 'receive' ? 'ğŸ“¥' : 'â„¹ï¸';
            const line = document.createElement('div');
            line.innerHTML = `<span style="color: #666">[${timestamp}]</span> ${prefix} ${message}`;
            logEl.appendChild(line);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function updateStatus(connected, endpoint = '') {
            const statusEl = document.getElementById('wsStatus');
            if (connected) {
                statusEl.textContent = `å·²è¿æ¥åˆ° ${endpoint}`;
                statusEl.className = 'status connected';
            } else {
                statusEl.textContent = 'æœªè¿æ¥';
                statusEl.className = 'status disconnected';
            }
        }

        function connectToUnityWS() {
            const port = document.getElementById('monitorPort').value;
            const name = document.getElementById('lanlanName').value;
            const url = `ws://localhost:${port}/ws/${name}`;
            connectWS(url, 'Unityç«¯ç‚¹');
        }

        function connectToSyncWS() {
            const port = document.getElementById('monitorPort').value;
            const name = document.getElementById('lanlanName').value;
            const url = `ws://localhost:${port}/sync/${name}`;
            connectWS(url, 'åŒæ­¥ç«¯ç‚¹');
        }

        function connectWS(url, type) {
            if (ws) {
                ws.close();
            }
            
            wsType = type;
            log(`å°è¯•è¿æ¥åˆ° ${type}: ${url}`);
            
            ws = new WebSocket(url);
            
            ws.onopen = () => {
                log(`âœ… æˆåŠŸè¿æ¥åˆ° ${type}`);
                updateStatus(true, type);
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    log(`æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(data, null, 2)}`, 'receive');
                } catch (e) {
                    log(`æ”¶åˆ°æ–‡æœ¬: ${event.data}`, 'receive');
                }
            };
            
            ws.onclose = () => {
                log(`âŒ ${type} è¿æ¥å·²å…³é—­`);
                updateStatus(false);
            };
            
            ws.onerror = (error) => {
                log(`âŒ ${type} è¿æ¥é”™è¯¯: ${error}`, 'error');
                updateStatus(false);
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function sendMessage(message) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('âŒ WebSocketæœªè¿æ¥', 'error');
                return;
            }
            
            const msgStr = typeof message === 'string' ? message : JSON.stringify(message);
            ws.send(msgStr);
            log(`å‘é€æ¶ˆæ¯: ${msgStr}`, 'send');
        }

        function sendAnimationCommand() {
            const cmd = {
                "type": "anim.play",
                "state": "EE_vrm_baked",
                "layer": 0,
                "fade": 0.25,
                "speed": 1
            };
            sendMessage(cmd);
        }

        function sendExpressionCommand() {
            const cmd = {
                "type": "face.expression",
                "name": "happy",
                "weight": 0.8
            };
            sendMessage(cmd);
        }

        function sendMouthCommand() {
            const cmd = {
                "type": "face.mouth",
                "aa": 0.6,
                "ee": 0.2,
                "ih": 0,
                "oh": 0.1,
                "ou": 0
            };
            sendMessage(cmd);
        }

        function sendCustomCommand() {
            const customText = document.getElementById('customCommand').value.trim();
            if (!customText) {
                log('âŒ è¯·è¾“å…¥è‡ªå®šä¹‰æŒ‡ä»¤', 'error');
                return;
            }
            
            try {
                const cmd = JSON.parse(customText);
                sendMessage(cmd);
            } catch (e) {
                log(`âŒ JSONæ ¼å¼é”™è¯¯: ${e.message}`, 'error');
            }
        }

        async function testUnityAPI() {
            const name = document.getElementById('lanlanName').value;
            const commands = [
                {"type": "anim.play", "state": "EE_vrm_baked", "layer": 0, "fade": 0.25, "speed": 1},
                {"type": "face.expression", "name": "happy", "weight": 0.8}
            ];
            
            try {
                const response = await fetch('/api/unity/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lanlan_name: name, commands: commands })
                });
                
                const result = await response.json();
                log(`APIå“åº”: ${JSON.stringify(result, null, 2)}`);
            } catch (e) {
                log(`âŒ APIè°ƒç”¨å¤±è´¥: ${e.message}`, 'error');
            }
        }

        async function testLLMTrigger() {
            log('ğŸ¤– æ¨¡æ‹ŸLLMç”ŸæˆæŒ‡ä»¤...');
            await testUnityAPI();
            log('ğŸ’¡ å¦‚æœUnityæ­£ç¡®è¿æ¥ï¼Œåº”è¯¥èƒ½çœ‹åˆ°åŠ¨ç”»å’Œè¡¨æƒ…å˜åŒ–');
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = () => {
            log('ğŸš€ Unity WebSocket è°ƒè¯•å·¥å…·å·²å¯åŠ¨');
            log('ğŸ’¡ è¯·å…ˆç¡®ä¿ç›‘æ§æœåŠ¡ (monitor.py) æ­£åœ¨è¿è¡Œ');
        };
    </script>
</body>
</html>